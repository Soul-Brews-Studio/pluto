<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KlakMath Music Visualizer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            cursor: crosshair;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .ui-overlay {
            position: fixed;
            z-index: 100;
            pointer-events: none;
        }

        .ui-overlay * {
            pointer-events: auto;
        }

        /* Header */
        .header {
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.5) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.4);
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        /* Audio Controls */
        .audio-controls {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            transition: opacity 0.5s ease;
        }

        .audio-controls.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .audio-controls h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .audio-controls p {
            color: rgba(255,255,255,0.5);
            font-size: 0.85rem;
            max-width: 400px;
            text-align: center;
            line-height: 1.6;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 16px 32px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 50px;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .btn.primary {
            background: #fff;
            color: #000;
            border-color: #fff;
        }

        .btn.primary:hover {
            box-shadow: 0 10px 40px rgba(255,255,255,0.3);
        }

        .btn svg {
            width: 20px;
            height: 20px;
        }

        .file-input {
            display: none;
        }

        /* Mode Selector */
        .mode-selector {
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
            padding: 6px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .mode-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.5);
            padding: 10px 20px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 40px;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            color: rgba(255,255,255,0.8);
        }

        .mode-btn.active {
            background: #fff;
            color: #000;
        }

        /* Side Panel */
        .side-panel {
            top: 50%;
            right: 30px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 180px;
        }

        .control-item {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .control-label {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 8px;
            display: block;
        }

        .control-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            font-weight: 500;
            color: #fff;
            display: block;
            margin-bottom: 10px;
        }

        input[type="range"] {
            width: 100%;
            height: 2px;
            background: rgba(255,255,255,0.15);
            border-radius: 2px;
            -webkit-appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }

        /* Stats */
        .stats-panel {
            top: 30px;
            left: 30px;
        }

        .stat-row {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 0.7rem;
        }

        .stat-label {
            color: rgba(255,255,255,0.3);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            color: rgba(255,255,255,0.7);
        }

        /* Audio Info */
        .audio-info {
            top: 30px;
            right: 30px;
            text-align: right;
        }

        .audio-info .source {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 5px;
        }

        .audio-info .status {
            font-size: 0.85rem;
            color: #4ade80;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }

        .audio-info .status::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        /* Frequency Bars */
        .freq-display {
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 3px;
            height: 60px;
            align-items: flex-end;
        }

        .freq-bar {
            width: 4px;
            background: linear-gradient(to top, #6366f1, #ec4899);
            border-radius: 2px;
            transition: height 0.05s ease;
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.8s ease;
        }

        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-text {
            font-size: 0.8rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .side-panel { display: none; }
            .header h1 { font-size: 1.5rem; }
            .btn-group { flex-direction: column; }
            .freq-display { display: none; }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <span class="loading-text">Initializing</span>
    </div>

    <div id="canvas-container"></div>

    <!-- Header -->
    <div class="ui-overlay header">
        <h1>Music Visualizer</h1>
        <p>Powered by KlakMath</p>
    </div>

    <!-- Audio Source Selection -->
    <div class="ui-overlay audio-controls" id="audioControls">
        <h2>Select Audio Source</h2>
        <p>Choose microphone to capture system audio (play YouTube/Spotify in background) or upload an audio file</p>
        <div class="btn-group">
            <button class="btn primary" id="micBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"/>
                    <line x1="8" y1="23" x2="16" y2="23"/>
                </svg>
                Microphone
            </button>
            <button class="btn" id="fileBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18V5l12-2v13"/>
                    <circle cx="6" cy="18" r="3"/>
                    <circle cx="18" cy="16" r="3"/>
                </svg>
                Audio File
            </button>
        </div>
        <input type="file" id="audioFile" class="file-input" accept="audio/*">
    </div>

    <!-- Stats -->
    <div class="ui-overlay stats-panel" id="statsPanel" style="display: none;">
        <div class="stat-row">
            <span class="stat-label">FPS</span>
            <span class="stat-value" id="fps">60</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Bass</span>
            <span class="stat-value" id="bass">0.00</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Mid</span>
            <span class="stat-value" id="mid">0.00</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">High</span>
            <span class="stat-value" id="high">0.00</span>
        </div>
    </div>

    <!-- Audio Info -->
    <div class="ui-overlay audio-info" id="audioInfo" style="display: none;">
        <div class="source" id="audioSource">Microphone</div>
        <div class="status">Listening</div>
    </div>

    <!-- Frequency Display -->
    <div class="ui-overlay freq-display" id="freqDisplay" style="display: none;"></div>

    <!-- Mode Selector -->
    <div class="ui-overlay mode-selector" id="modeSelector" style="display: none;">
        <button class="mode-btn active" data-mode="sphere">Sphere</button>
        <button class="mode-btn" data-mode="bars">Bars</button>
        <button class="mode-btn" data-mode="wave">Wave</button>
        <button class="mode-btn" data-mode="galaxy">Galaxy</button>
    </div>

    <!-- Side Controls -->
    <div class="ui-overlay side-panel" id="sidePanel" style="display: none;">
        <div class="control-item">
            <span class="control-label">Sensitivity</span>
            <span class="control-value" id="sensitivityValue">1.0</span>
            <input type="range" id="sensitivity" min="0.5" max="3" step="0.1" value="1">
        </div>
        <div class="control-item">
            <span class="control-label">Smoothing</span>
            <span class="control-value" id="smoothingValue">0.8</span>
            <input type="range" id="smoothing" min="0.5" max="0.95" step="0.05" value="0.8">
        </div>
        <div class="control-item">
            <span class="control-label">Color Shift</span>
            <span class="control-value" id="colorShiftValue">1.0</span>
            <input type="range" id="colorShift" min="0.1" max="3" step="0.1" value="1">
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // ============================================================
        // KlakMath
        // ============================================================

        class XXHash {
            constructor(seed) { this.seed = seed >>> 0; }
            static rotl32(x, r) { return ((x << r) | (x >>> (32 - r))) >>> 0; }
            hash(data) {
                const P1=2654435761, P2=2246822519, P3=3266489917, P4=668265263, P5=374761393;
                data = data >>> 0;
                let h = (this.seed + P5 + 4) >>> 0;
                h = (h + Math.imul(data, P3)) >>> 0;
                h = (Math.imul(XXHash.rotl32(h, 17), P4)) >>> 0;
                h ^= h >>> 15; h = Math.imul(h, P2) >>> 0;
                h ^= h >>> 13; h = Math.imul(h, P3) >>> 0;
                return (h ^ (h >>> 16)) >>> 0;
            }
            float(data, min=0, max=1) { return min + (max-min) * (this.hash(data) / 0xFFFFFFFF); }
            onSphere(data) {
                const phi = this.float(data, 0, Math.PI * 2);
                const z = this.float(data + 0x10000000, -1, 1);
                const w = Math.sqrt(1 - z * z);
                return new THREE.Vector3(Math.cos(phi) * w, z, Math.sin(phi) * w);
            }
        }

        const Noise = {
            float(p, seed) {
                const hash = new XXHash(seed);
                const i = Math.floor(p) + 0x10000000;
                const x = p - Math.floor(p);
                let k0 = x, k1 = 1 - x;
                k0 = 1 - k0*k0; k1 = 1 - k1*k1;
                k0 = k0*k0*k0; k1 = k1*k1*k1;
                return (k0 * hash.float(i,-1,1) * x + k1 * hash.float(i+1,-1,1) * (x-1)) * 2.37;
            },
            fractal(p, oct, seed) {
                let f=0, w=1;
                for(let i=0; i<oct; i++) { f += w * this.float(p, seed+i); p *= 2; w *= 0.5; }
                return f;
            }
        };

        const ExpTween = {
            step: (cur, tar, spd, dt) => cur + (tar - cur) * (1 - Math.exp(-spd * dt))
        };

        // ============================================================
        // Audio Analyzer
        // ============================================================

        class AudioAnalyzer {
            constructor() {
                this.audioContext = null;
                this.analyser = null;
                this.dataArray = null;
                this.source = null;
                this.isActive = false;
                this.smoothedBass = 0;
                this.smoothedMid = 0;
                this.smoothedHigh = 0;
                this.smoothedVolume = 0;
            }

            async initMicrophone() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        }
                    });
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 512;
                    this.analyser.smoothingTimeConstant = 0.8;

                    this.source = this.audioContext.createMediaStreamSource(stream);
                    this.source.connect(this.analyser);

                    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    this.isActive = true;
                    return true;
                } catch (err) {
                    console.error('Microphone error:', err);
                    return false;
                }
            }

            async initFile(file) {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 512;
                    this.analyser.smoothingTimeConstant = 0.8;

                    const arrayBuffer = await file.arrayBuffer();
                    const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);

                    this.source = this.audioContext.createBufferSource();
                    this.source.buffer = audioBuffer;
                    this.source.loop = true;
                    this.source.connect(this.analyser);
                    this.analyser.connect(this.audioContext.destination);
                    this.source.start(0);

                    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    this.isActive = true;
                    return true;
                } catch (err) {
                    console.error('File error:', err);
                    return false;
                }
            }

            update(smoothing = 0.8, sensitivity = 1) {
                if (!this.isActive || !this.analyser) return;

                this.analyser.getByteFrequencyData(this.dataArray);
                const len = this.dataArray.length;

                // Calculate frequency bands
                let bass = 0, mid = 0, high = 0;
                const bassEnd = Math.floor(len * 0.1);
                const midEnd = Math.floor(len * 0.5);

                for (let i = 0; i < bassEnd; i++) bass += this.dataArray[i];
                for (let i = bassEnd; i < midEnd; i++) mid += this.dataArray[i];
                for (let i = midEnd; i < len; i++) high += this.dataArray[i];

                bass = (bass / bassEnd / 255) * sensitivity;
                mid = (mid / (midEnd - bassEnd) / 255) * sensitivity;
                high = (high / (len - midEnd) / 255) * sensitivity;

                // Smooth values
                this.smoothedBass = this.smoothedBass * smoothing + bass * (1 - smoothing);
                this.smoothedMid = this.smoothedMid * smoothing + mid * (1 - smoothing);
                this.smoothedHigh = this.smoothedHigh * smoothing + high * (1 - smoothing);
                this.smoothedVolume = (this.smoothedBass + this.smoothedMid + this.smoothedHigh) / 3;
            }

            getFrequencyData() {
                return this.dataArray || new Uint8Array(256);
            }

            getBass() { return this.smoothedBass; }
            getMid() { return this.smoothedMid; }
            getHigh() { return this.smoothedHigh; }
            getVolume() { return this.smoothedVolume; }
        }

        // ============================================================
        // Visualizer
        // ============================================================

        let scene, camera, renderer, composer, controls;
        let particles, particleGeometry, particleMaterial;
        let bars = [], barGroup;
        let waveGeometry, waveMesh;
        let audioAnalyzer;
        let currentMode = 'sphere';
        let time = 0;
        let params = { sensitivity: 1, smoothing: 0.8, colorShift: 1 };
        let basePositions = [];

        const PARTICLE_COUNT = 6000;
        const BAR_COUNT = 64;
        const clock = new THREE.Clock();
        let frameCount = 0, fps = 60, lastFpsUpdate = 0;

        function init() {
            audioAnalyzer = new AudioAnalyzer();

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000508);
            scene.fog = new THREE.FogExp2(0x000508, 0.06);

            // Camera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 2, 6);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.5;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.5;

            // Post Processing
            composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));
            const bloom = new UnrealBloomPass(
                new THREE.Vector2(window.innerWidth, window.innerHeight),
                2.0, 0.5, 0.1
            );
            composer.addPass(bloom);

            // Create visualizations
            createParticles();
            createBars();
            createWave();
            createFreqDisplay();

            // Events
            window.addEventListener('resize', onWindowResize);
            setupUI();

            // Hide loading
            setTimeout(() => document.getElementById('loading').classList.add('hidden'), 500);

            animate();
        }

        function createParticles() {
            particleGeometry = new THREE.BufferGeometry();
            const positions = new Float32Array(PARTICLE_COUNT * 3);
            const colors = new Float32Array(PARTICLE_COUNT * 3);
            const sizes = new Float32Array(PARTICLE_COUNT);
            const hash = new XXHash(42);

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const pos = hash.onSphere(i).multiplyScalar(2);
                positions[i*3] = pos.x;
                positions[i*3+1] = pos.y;
                positions[i*3+2] = pos.z;
                basePositions.push(pos.clone());

                const hue = hash.float(i + 1000, 0.5, 0.8);
                const color = new THREE.Color().setHSL(hue, 0.9, 0.6);
                colors[i*3] = color.r;
                colors[i*3+1] = color.g;
                colors[i*3+2] = color.b;
                sizes[i] = hash.float(i + 2000, 0.3, 1.2);
            }

            particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particleGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            particleGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            particleMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    uTime: { value: 0 },
                    uBass: { value: 0 },
                    uPixelRatio: { value: renderer.getPixelRatio() }
                },
                vertexShader: `
                    attribute float size;
                    varying vec3 vColor;
                    uniform float uTime;
                    uniform float uBass;
                    uniform float uPixelRatio;
                    void main() {
                        vColor = color;
                        vec3 pos = position * (1.0 + uBass * 0.5);
                        vec4 mv = modelViewMatrix * vec4(pos, 1.0);
                        gl_PointSize = size * uPixelRatio * (250.0 / -mv.z) * (1.0 + uBass);
                        gl_Position = projectionMatrix * mv;
                    }
                `,
                fragmentShader: `
                    varying vec3 vColor;
                    void main() {
                        float d = length(gl_PointCoord - 0.5);
                        if (d > 0.5) discard;
                        float a = pow(1.0 - d * 2.0, 2.0);
                        gl_FragColor = vec4(vColor * 1.5, a);
                    }
                `,
                transparent: true,
                vertexColors: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            particles = new THREE.Points(particleGeometry, particleMaterial);
            scene.add(particles);
        }

        function createBars() {
            barGroup = new THREE.Group();
            const radius = 3;

            for (let i = 0; i < BAR_COUNT; i++) {
                const angle = (i / BAR_COUNT) * Math.PI * 2;
                const geo = new THREE.BoxGeometry(0.15, 1, 0.15);
                const mat = new THREE.MeshBasicMaterial({
                    color: new THREE.Color().setHSL(i / BAR_COUNT, 0.8, 0.5),
                    transparent: true,
                    opacity: 0.9
                });
                const bar = new THREE.Mesh(geo, mat);
                bar.position.x = Math.cos(angle) * radius;
                bar.position.z = Math.sin(angle) * radius;
                bar.rotation.y = -angle;
                bars.push(bar);
                barGroup.add(bar);
            }

            barGroup.visible = false;
            scene.add(barGroup);
        }

        function createWave() {
            const segments = 128;
            waveGeometry = new THREE.BufferGeometry();
            const positions = new Float32Array(segments * 3);

            for (let i = 0; i < segments; i++) {
                positions[i*3] = (i / segments - 0.5) * 10;
                positions[i*3+1] = 0;
                positions[i*3+2] = 0;
            }

            waveGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

            const waveMat = new THREE.LineBasicMaterial({
                color: 0x6366f1,
                linewidth: 2,
                transparent: true,
                opacity: 0.8
            });

            waveMesh = new THREE.Line(waveGeometry, waveMat);
            waveMesh.visible = false;
            scene.add(waveMesh);
        }

        function createFreqDisplay() {
            const container = document.getElementById('freqDisplay');
            for (let i = 0; i < 32; i++) {
                const bar = document.createElement('div');
                bar.className = 'freq-bar';
                bar.style.height = '2px';
                container.appendChild(bar);
            }
        }

        function updateVisualizer(dt) {
            audioAnalyzer.update(params.smoothing, params.sensitivity);

            const bass = audioAnalyzer.getBass();
            const mid = audioAnalyzer.getMid();
            const high = audioAnalyzer.getHigh();
            const volume = audioAnalyzer.getVolume();
            const freqData = audioAnalyzer.getFrequencyData();

            // Update stats
            document.getElementById('bass').textContent = bass.toFixed(2);
            document.getElementById('mid').textContent = mid.toFixed(2);
            document.getElementById('high').textContent = high.toFixed(2);

            // Update frequency bars display
            const freqBars = document.querySelectorAll('.freq-bar');
            const step = Math.floor(freqData.length / freqBars.length);
            freqBars.forEach((bar, i) => {
                const value = freqData[i * step] / 255;
                bar.style.height = `${2 + value * 58}px`;
                bar.style.opacity = 0.4 + value * 0.6;
            });

            // Update colors based on audio
            const hueShift = time * params.colorShift * 0.1;
            const positions = particleGeometry.attributes.position.array;
            const colors = particleGeometry.attributes.color.array;
            const hash = new XXHash(42);

            particles.visible = currentMode === 'sphere' || currentMode === 'galaxy';
            barGroup.visible = currentMode === 'bars';
            waveMesh.visible = currentMode === 'wave';

            if (currentMode === 'sphere') {
                // Sphere reactive to audio
                for (let i = 0; i < PARTICLE_COUNT; i++) {
                    const base = basePositions[i];
                    const freqIndex = Math.floor(hash.float(i, 0, 1) * freqData.length);
                    const freqValue = freqData[freqIndex] / 255;

                    const noiseOffset = Noise.fractal(base.x + time * 0.5, 3, i) * 0.3;
                    const scale = 2 + freqValue * 1.5 + noiseOffset;

                    positions[i*3] = ExpTween.step(positions[i*3], base.x * scale, 8, dt);
                    positions[i*3+1] = ExpTween.step(positions[i*3+1], base.y * scale, 8, dt);
                    positions[i*3+2] = ExpTween.step(positions[i*3+2], base.z * scale, 8, dt);

                    // Color shift
                    const hue = (hash.float(i + 1000, 0.5, 0.8) + hueShift + freqValue * 0.2) % 1;
                    const color = new THREE.Color().setHSL(hue, 0.9, 0.5 + freqValue * 0.3);
                    colors[i*3] = color.r;
                    colors[i*3+1] = color.g;
                    colors[i*3+2] = color.b;
                }

                particleMaterial.uniforms.uBass.value = bass;
                particles.rotation.y += dt * 0.1 * (1 + bass);

            } else if (currentMode === 'galaxy') {
                // Galaxy spiral
                for (let i = 0; i < PARTICLE_COUNT; i++) {
                    const t = i / PARTICLE_COUNT;
                    const angle = t * Math.PI * 8 + time * 0.2;
                    const radius = 0.5 + t * 3;
                    const freqIndex = Math.floor(t * freqData.length);
                    const freqValue = freqData[freqIndex] / 255;

                    const heightOffset = Noise.fractal(t * 10 + time, 2, i) * (0.5 + freqValue);

                    const tx = Math.cos(angle) * radius;
                    const ty = heightOffset;
                    const tz = Math.sin(angle) * radius;

                    positions[i*3] = ExpTween.step(positions[i*3], tx, 5, dt);
                    positions[i*3+1] = ExpTween.step(positions[i*3+1], ty, 5, dt);
                    positions[i*3+2] = ExpTween.step(positions[i*3+2], tz, 5, dt);

                    const hue = (t + hueShift) % 1;
                    const color = new THREE.Color().setHSL(hue, 0.8, 0.5 + freqValue * 0.3);
                    colors[i*3] = color.r;
                    colors[i*3+1] = color.g;
                    colors[i*3+2] = color.b;
                }

                particles.rotation.y += dt * 0.3 * (1 + bass * 0.5);

            } else if (currentMode === 'bars') {
                // Circular bars
                const step = Math.floor(freqData.length / BAR_COUNT);
                bars.forEach((bar, i) => {
                    const value = freqData[i * step] / 255;
                    const targetHeight = 0.2 + value * 4;
                    bar.scale.y = ExpTween.step(bar.scale.y, targetHeight, 15, dt);
                    bar.position.y = bar.scale.y / 2;

                    const hue = (i / BAR_COUNT + hueShift) % 1;
                    bar.material.color.setHSL(hue, 0.8, 0.4 + value * 0.4);
                });

                barGroup.rotation.y += dt * 0.2 * (1 + bass);

            } else if (currentMode === 'wave') {
                // Waveform
                const wavePositions = waveGeometry.attributes.position.array;
                const segments = wavePositions.length / 3;
                const step = Math.floor(freqData.length / segments);

                for (let i = 0; i < segments; i++) {
                    const value = freqData[i * step] / 255;
                    wavePositions[i*3+1] = value * 3 - 1.5;
                }

                waveGeometry.attributes.position.needsUpdate = true;
                waveMesh.rotation.y += dt * 0.1;
            }

            particleGeometry.attributes.position.needsUpdate = true;
            particleGeometry.attributes.color.needsUpdate = true;
            particleMaterial.uniforms.uTime.value = time;
        }

        function animate() {
            requestAnimationFrame(animate);

            const dt = Math.min(clock.getDelta(), 0.1);
            time += dt;

            if (audioAnalyzer.isActive) {
                updateVisualizer(dt);
            }

            controls.update();
            composer.render();

            // FPS
            frameCount++;
            if (time - lastFpsUpdate >= 0.5) {
                fps = Math.round(frameCount / (time - lastFpsUpdate));
                frameCount = 0;
                lastFpsUpdate = time;
                document.getElementById('fps').textContent = fps;
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        function showUI() {
            document.getElementById('audioControls').classList.add('hidden');
            document.getElementById('statsPanel').style.display = 'block';
            document.getElementById('audioInfo').style.display = 'block';
            document.getElementById('freqDisplay').style.display = 'flex';
            document.getElementById('modeSelector').style.display = 'flex';
            document.getElementById('sidePanel').style.display = 'flex';
        }

        function setupUI() {
            // Mic button
            document.getElementById('micBtn').addEventListener('click', async () => {
                const success = await audioAnalyzer.initMicrophone();
                if (success) {
                    document.getElementById('audioSource').textContent = 'Microphone';
                    showUI();
                }
            });

            // File button
            document.getElementById('fileBtn').addEventListener('click', () => {
                document.getElementById('audioFile').click();
            });

            document.getElementById('audioFile').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const success = await audioAnalyzer.initFile(file);
                    if (success) {
                        document.getElementById('audioSource').textContent = file.name;
                        showUI();
                    }
                }
            });

            // Mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMode = btn.dataset.mode;
                });
            });

            // Sliders
            document.getElementById('sensitivity').addEventListener('input', (e) => {
                params.sensitivity = parseFloat(e.target.value);
                document.getElementById('sensitivityValue').textContent = params.sensitivity.toFixed(1);
            });

            document.getElementById('smoothing').addEventListener('input', (e) => {
                params.smoothing = parseFloat(e.target.value);
                document.getElementById('smoothingValue').textContent = params.smoothing.toFixed(2);
            });

            document.getElementById('colorShift').addEventListener('input', (e) => {
                params.colorShift = parseFloat(e.target.value);
                document.getElementById('colorShiftValue').textContent = params.colorShift.toFixed(1);
            });
        }

        init();
    </script>
</body>
</html>
